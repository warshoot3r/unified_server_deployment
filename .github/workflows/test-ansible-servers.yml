name: "Automatic - Build and push multi tag as branch name"

on:
  push:
    branches: 
      - $default-branch
    paths-ignore: 
      - ".github"

  
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false

    steps:
        - name: Checkout
          uses: actions/checkout@v3
    
        - name: Install Ansible
          run: sudo apt-get update && sudo apt-get install -y ansible

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v2
      
        - name: Build Docker Image
          run: docker build -t ansible-test-instance testing/.

        - name: Start Docker Container
          run: docker run -d --name ansible-test-instance ansible-test-container
  

        - name: Wait for Container to Be Up and Running
          run: docker wait ansible-test-instance
            
        - name: Run Tests on built docker image
          run: |
            export ANSIBLE_CONFIG=roles
            ansible-playbook servers/piscrape/playbook.yml --inventory "localhost," --extra-vars "container_name=ansible-test-instance"
        
        - name: Stop and Remove Docker Container
          run: docker stop ansible-test-instance && docker rm ansible-test-instance