name: "Automatic - Build and push multi tag as branch name"

on:
  push:
    paths-ignore: 
      - ".github"

jobs:
  cache-apt-packages:
        name: Cache APT Packages
        runs-on: ubuntu-latest
    
        steps:
        - name: Cache APT Packages
          uses: actions/cache@v2
          with:
            path: /var/cache/apt/archives
            key: apt-packages-${{ runner.os }}-${{ hashFiles('README.md') }}
            restore-keys: |
              apt-packages-${{ runner.os }}-
    
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    needs: cache-apt-packages  # Make sure this job runs first
    steps:
        - name: Checkout
          uses: actions/checkout@v3

        - name: Generate SSH key pair
          run: ssh-keygen -t rsa -b 4096 -f testing/id_rsa -N ""

        - name: set up host ssh
          run: |
            mkdir -p ~/.ssh
            cp testing/id_rsa ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa

        - name: Start SSH agent
          run: |
            exec ssh-agent bash
            eval '$(ssh-agent -s)'

              
        - name: Install Ansible
          run: sudo apt-get update && sudo apt-get install -y ansible

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v2
      
        - name: Build Docker Image
          run: docker build -t ansible-test-instance testing/. 

        - name: Start Docker Container
          run: docker-compose -f testing/docker-compose.yml up -d


        - name: Run Tests on built docker image
          run: |
            export ANSIBLE_CONFIG="testing/ansible_test.cfg" &&
            ansible-playbook servers/pi-node1/playbook.yml --inventory "testing/inventory.yml" -e "@testing/variables.yml" -v
        
        - name: Stop and Remove Docker Container
          run: docker stop ansible-test-instance && docker rm ansible-test-instance